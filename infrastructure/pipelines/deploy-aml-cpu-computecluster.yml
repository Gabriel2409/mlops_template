variables:
  # - ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
  #     # 'main' branch: PRD environment
  #     - template: ../config-infra-prod.yml
  # - ${{ if ne(variables['Build.SourceBranchName'], 'main') }}:
  #     # 'develop' or feature branches: DEV environment
  #     - template: ../config-infra-dev.yml
  - template: ../config-infra-prod.yml
  - name: bicepFile
    value: "./infrastructure/modules/aml_cpu_computecluster.bicep"
  - name: computeClusterName
    value: cpu-cluster

trigger:
  - none

pool:
  vmImage: $(ap_vm_image)

stages:
  - template: ../templates/lint-bicep.yml
    parameters:
      bicepFile: $(bicepFile)
  - stage: PreflightValidation
    jobs:
      - job: ValidateBicepCode
        displayName: Validate Bicep Code (Rg level)
        steps:
          - task: AzureCli@2
            name: RunPreflightValidateion
            displayName: Run Preflight Validation
            inputs:
              azureSubscription: $(ado_service_connection_rg)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                az deployment group validate \
                  --resource-group $(resource_group) \
                  --name $(Build.DefinitionName) \
                  --template-file $(bicepFile) \
                  --parameters location=$(location) aml_workspace=$(aml_workspace) name=$(computeClusterName)

  - stage: CheckOutBicepAndDeploy
    displayName: Deploy Bicep resources
    jobs:
      - deployment: DevDeployBicep
        displayName: Deploy Bicep (Rg level)
        pool:
          vmImage: $(ap_vm_image)
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: Running ${{ variables.environment }} Deployment
                  inputs:
                    azureSubscription: $(ado_service_connection_rg)
                    scriptType: bash
                    scriptLocation: inlineScript

                    inlineScript: |
                      az --version
                      echo "deploying bicep..."
                      az deployment group create \
                        --resource-group $(resource_group) \
                        --name $(Build.DefinitionName) \
                        --template-file $(bicepFile) \
                        --parameters location=$(location) aml_workspace=$(aml_workspace) name=$(computeClusterName)
